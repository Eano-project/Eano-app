<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EANO • Dashboard</title>
<style>
  :root {
    --gold: #ffd700;
    --dark: #111;
    --light: #f5f5f5;
    --top-h: 60px;
  }
  * {
    box-sizing: border-box;
    scroll-behavior: smooth;
  }
  body {
    margin: 0;
    font-family: Roboto, Segoe UI, Arial, Helvetica, sans-serif;
    background: url('eano-bg.png') no-repeat center/cover fixed;
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
  }
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    z-index: -1;
  }

  .topbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--top-h);
    padding: 0 .8rem;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 900;
  }
  .brand {
    font-weight: 700;
    font-size: 1.25rem;
    color: var(--gold);
  }

  #mine-btn {
    position: fixed;
    top: 45%;
    right: 10px;
    transform: translateY(-50%);
    background: linear-gradient(45deg, var(--gold), #ff9100);
    border: none;
    border-radius: 14px;
    color: #000;
    padding: 14px 18px;
    font-weight: 700;
    box-shadow: 0 0 10px var(--gold);
    animation: glow 1.5s infinite alternate;
    cursor: pointer;
    z-index: 910;
  }
  @keyframes glow {
    0% { box-shadow: 0 0 6px var(--gold); }
    100% { box-shadow: 0 0 20px var(--gold); }
  }
  #theme-toggle {
    position: fixed;
    top: calc(45% + 70px);
    right: 10px;
    background: rgba(0, 0, 0, .7);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 46px;
    height: 46px;
    font-size: 1.2rem;
    cursor: pointer;
  }

  .wrapper {
    padding-top: calc(var(--top-h) + 20px);
    max-width: 600px;
    margin: auto;
    padding-bottom: 100px;
  }

  .announcement {
    background: linear-gradient(135deg, #ffa726, #ffca28);
    color: #000;
    padding: 1.1rem;
    border-radius: 14px;
    font-weight: 500;
    text-align: center;
    margin: 0 10px 26px;
    box-shadow: 0 3px 8px rgba(0,0,0,.35);
  }
  .announcement img {
    max-width: 100%;
    height: auto;
    max-height: 400px; /* Limits height for tall images like 1080x1350 */
    border-radius: 8px;
    margin-top: 10px;
    object-fit: contain; /* Preserves aspect ratio */
  }

  .coming-box {
    background: rgba(255,255,255,.1);
    border: 1px dashed var(--gold);
    margin: 14px 10px;
    padding: 40px 12px;
    border-radius: 14px;
    text-align: center;
    font-size: 1rem;
  }

  .scrollable a.feature, .scrollable button.feature {
    display: block;
    margin: 12px 10px;
    padding: 12px;
    background: rgba(255,255,255,.1);
    border-radius: 12px;
    color: var(--gold);
    font-weight: 600;
    text-decoration: none;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    border: none;
    font: inherit;
    cursor: pointer;
  }

  #leaderboard {
    margin: 20px 10px;
    display: none;
  }
  #leaderboard.active { display: block; }
  #leaderboard-list li {
    padding: 8px;
    background: rgba(255,255,255,0.1);
    margin: 4px 0;
    border-radius: 6px;
  }

  .light body,
  .light .wrapper { color: #111; }
  body.light { color: #111; }
  body.light .topbar {
    background: rgba(255,255,255,.9);
    color: #000;
  }
  body.light .announcement { color: #000; }

  @media(max-width: 500px){
    #mine-btn { right: 6px; padding: 12px 14px; }
    #theme-toggle { right: 6px; }
  }
</style>
</head>
<body>

<!-- TOPBAR -->
<header class="topbar">
  <span class="brand">EANO</span>
  <span><span id="balance">0.000</span> EANO | <span id="timer">⏳</span></span>
  <div>
    <select id="lang-select">
      <option value="en">EN</option><option value="fr">FR</option><option value="sw">SW</option>
      <option value="ig">IG</option><option value="ha">HA</option><option value="zh">中文</option>
    </select>
  </div>
</header>

<button id="mine-btn">⛏ Mine</button>
<button id="theme-toggle">🌗</button>

<main class="wrapper">
  <section id="profile-info" style="text-align:center;margin-bottom:20px;">
    <p><strong>Username:</strong> <span id="username">Loading...</span></p>
    <p><strong>Referrals:</strong> <span id="referral-count">0</span></p>
    <p><strong>Mining Level:</strong> <span id="level">🥚 Beginner</span></p>
    <p><strong>Trust Score:</strong> <span id="trust-score">0</span></p>
  </section>

  <div class="scrollable" id="main-content">
    <a href="#" class="feature" data-nav="home">🏡 Home</a>
    <a href="#" class="feature" data-nav="mainnet">🚀 Mainnet (Soon)</a>
    <a href="leaderboard.html" class="feature" data-nav="leaderboard">🏆 Leaderboard</a>
    <a href="team.html" class="feature" data-nav="team">👥 Team</a>
    <a href="community.html" class="feature" data-nav="community">💬 Community</a>
    <a href="profile.html" class="feature" data-nav="profile">👤 Profile</a>
    <a href="#" class="feature" data-nav="author">📝 Author</a>
    <a href="#" class="feature" data-nav="whitepaper">📄 WhitePaper</a>
    <a href="https://t.me/eanocoin" class="feature" target="_blank">🛠 Support Portal</a>
    <button id="logout-btn" class="feature">🚪 Logout</button>
    <a href="guide.html" class="feature glow">📘 Guide</a>
    <a href="rewards.html" class="feature glow">🎁 Gifts</a>
    <a href="earnings.html" class="feature glow">💼 Earnings</a>
    <a href="game/dashboard.html" target="_blank" class="feature glow">🎮 EANO-Games</a>
    <div class="coming-box">🛍️ EANO-Marketplace – Coming Soon...</a>
    <div class="coming-box">🎙 EANO-Studio - Coming Soon...</a>
    <div class="coming-box">⚙️ Extra Utilities – Coming Soon...</a>
  </div>

  <section id="leaderboard" style="margin: 20px 10px;">
    <h3>🏆 Leaderboard</h3>
    <ul id="leaderboard-list" style="list-style: none; padding: 0;">
      <li>Loading...</li>
    </ul>
  </section>
</main>
  
<script type="module">
import { db, doc, getDoc, onSnapshot } from './firebase.js';
import { auth, onAuthStateChanged } from './auth.js';
import { ref, get, set, update, query, orderByChild, limitToLast } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js';

const THEME_BTN = document.getElementById('theme-toggle');
const MINE_BTN = document.getElementById('mine-btn');
const BAL_EL = document.getElementById('balance');
const TIMER_EL = document.getElementById('timer');
const REF_EL = document.getElementById('referral-count');
const LEVEL_EL = document.getElementById('level');
const TRUST_EL = document.getElementById('trust-score');
const USERNAME_EL = document.getElementById('username');
const LEADERBOARD_LIST = document.getElementById('leaderboard-list');
const LOGOUT_BTN = document.getElementById('logout-btn');
const MAIN_CONTENT = document.getElementById('main-content');
const LEADERBOARD_SECTION = document.getElementById('leaderboard');
const ANNOUNCE_TEXT = document.getElementById('announceText');
const ANNOUNCE_IMAGE = document.getElementById('announceImage');

const RATE_PER_H = 0.2;
const MS_24H = 24 * 60 * 60 * 1000;

// Theme handling
const applyTheme = (mode) => {
  if (mode === 'light') {
    document.body.classList.add('light');
    THEME_BTN.textContent = '🌙';
  } else {
    document.body.classList.remove('light');
    THEME_BTN.textContent = '🌗';
  }
};
applyTheme(localStorage.getItem('theme') || 'dark');
THEME_BTN.onclick = () => {
  const newMode = document.body.classList.contains('light') ? 'dark' : 'light';
  localStorage.setItem('theme', newMode);
  applyTheme(newMode);
};

// User data
let userData = {
  balance: 0,
  lastMine: 0,
  referrals: 0,
  trustScore: 0,
  username: '',
  avatar: 'default.png',
  community: { joined: false },
  hardcodes: { code: '' }
};

function fmt(num) { return num.toFixed(3); }

function getLevel(bal) {
  if (bal >= 10000) return '🐉 Dragon';
  if (bal >= 5000) return '🐘 Elephant';
  if (bal >= 2500) return '🦍 Gorilla';
  if (bal >= 1200) return '🐻 Bear';
  if (bal >= 600) return '🐯 Lion';
  if (bal >= 300) return '🐼 Panda';
  if (bal >= 150) return '🐺 Wolf';
  if (bal >= 50) return '🐹 Hamster';
  return '🐥 Chicken';
}

function getTrustBadge(score) {
  if (score >= 10000) return '💎 O.G';
  if (score >= 5000) return '🟢 Trusted Miner';
  if (score >= 1000) return '🟡 Reliable Miner';
  if (score >= 500) return '🔵 New Miner';
  if (score < 100) return '🔴 Low Trust';
  return '';
}

async function refreshUI() {
  BAL_EL.textContent = fmt(userData.balance);
  REF_EL.textContent = userData.referrals;
  LEVEL_EL.textContent = getLevel(userData.balance);
  TRUST_EL.textContent = `${getTrustBadge(userData.trustScore)} (${userData.trustScore})`;
  USERNAME_EL.textContent = userData.username || 'Anonymous';
}

// Fetch user data
async function fetchUserData(uid) {
  const userRef = ref(rtdb, `users/${uid}`);
  const userSnap = await get(userRef);
  if (userSnap.exists()) {
    userData = { ...userData, ...userSnap.val() };
  } else {
    userData = { balance: 2.0, lastMine: 0, referrals: 0, trustScore: 0 };
    await set(userRef, userData);
  }

  const userDoc = await getDoc(doc(db, 'users', uid));
  if (userDoc.exists()) {
    userData = { ...userData, ...userDoc.data() };
  } else {
    const initialData = {
      username: '',
      avatar: 'default.png',
      community: { joined: false },
      hardcodes: { code: '' },
      miningLevel: getLevel(userData.balance)
    };
    await setDoc(doc(db, 'users', uid), initialData);
    userData = { ...userData, ...initialData };
  }
  refreshUI();
}

// Fetch announcement
function fetchAnnouncement() {
  const announceRef = doc(db, 'announcements', 'latest');
  onSnapshot(announceRef, (doc) => {
    if (doc.exists()) {
      const data = doc.data();
      ANNOUNCE_TEXT.textContent = data.message || 'No announcement.';
      if (data.imageUrl) {
        ANNOUNCE_IMAGE.src = data.imageUrl;
        ANNOUNCE_IMAGE.style.display = 'block';
      } else {
        ANNOUNCE_IMAGE.style.display = 'none';
      }
    } else {
      ANNOUNCE_TEXT.textContent = 'No announcement.';
      ANNOUNCE_IMAGE.style.display = 'none';
    }
  });
}

// Leaderboard
function updateLeaderboard() {
  const leaderboardQuery = query(ref(rtdb, 'users'), orderByChild('balance'), limitToLast(10));
  onValue(leaderboardQuery, async (snapshot) => {
    LEADERBOARD_LIST.innerHTML = '';
    const users = [];
    snapshot.forEach((child) => {
      const user = child.val();
      users.push({ id: child.key, ...user });
    });
    for (const user of users.reverse()) {
      const userDoc = await getDoc(doc(db, 'users', user.id));
      const username = userDoc.exists() ? userDoc.data().username || 'Anonymous' : 'Anonymous';
      const li = document.createElement('li');
      li.textContent = `${username} - ${fmt(user.balance)} EANO`;
      LEADERBOARD_LIST.appendChild(li);
    }
  });
}

// Countdown for mining
let countdownInt = null;
function startCountdown() {
  clearInterval(countdownInt);
  const end = userData.lastMine + MS_24H;
  const tick = () => {
    const rem = Math.max(0, Math.floor((end - Date.now()) / 1000));
    const h = Math.floor(rem / 3600),
          m = Math.floor((rem % 3600) / 60),
          s = rem % 60;
    TIMER_EL.textContent = `⏳ ${h}h ${m}m ${s}s`;
    if (rem <= 0) {
      TIMER_EL.textContent = '✅ Ready';
      MINE_BTN.disabled = false;
      MINE_BTN.textContent = '⛏ Mine';
      clearInterval(countdownInt);
    }
  };
  tick();
  countdownInt = setInterval(tick, 1000);
}

// Mining logic
MINE_BTN.onclick = async () => {
  if (Date.now() - userData.lastMine < MS_24H) return;
  const earned = RATE_PER_H * 24;
  userData.balance += earned;
  userData.lastMine = Date.now();
  const uid = auth.currentUser?.uid;
  if (uid) {
    await update(ref(rtdb, `users/${uid}`), {
      balance: userData.balance,
      lastMine: userData.lastMine,
      trustScore: userData.trustScore + 1
    });
    await updateDoc(doc(db, 'users', uid), {
      miningLevel: getLevel(userData.balance)
    });
  }
  refreshUI();
  MINE_BTN.disabled = true;
  MINE_BTN.textContent = '⏳ Wait';
  startCountdown();
  alert(`✅ Mined ${earned.toFixed(3)} EANO!`);
};

// Auth state handling
onAuthStateChanged(auth, async (user) => {
  if (user) {
    await fetchUserData(user.uid);
    fetchAnnouncement();
    if (Date.now() - userData.lastMine < MS_24H) {
      MINE_BTN.disabled = true;
      MINE_BTN.textContent = '⏳ Wait';
      startCountdown();
    }
  } else {
    window.location.href = 'index.html';
  }
});

// Navigation
MAIN_CONTENT.addEventListener('click', (e) => {
  if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
    e.preventDefault();
    if (e.target.id === 'logout-btn') {
      auth.signOut().then(() => {
        localStorage.removeItem('email');
        localStorage.removeItem('username');
        localStorage.removeItem('referral');
        localStorage.removeItem('fingerprint');
        alert('Logged out successfully.');
        window.location.href = 'index.html';
      }).catch((e) => alert('Logout failed: ' + e.message));
    } else if (e.target.dataset.nav === 'leaderboard') {
      MAIN_CONTENT.style.display = 'none';
      LEADERBOARD_SECTION.classList.add('active');
      updateLeaderboard();
    } else if (e.target.dataset.nav === 'home') {
      MAIN_CONTENT.style.display = 'block';
      LEADERBOARD_SECTION.classList.remove('active');
    } else if (e.target.dataset.nav === 'profile') {
      document.getElementById('profile-info').scrollIntoView({ behavior: 'smooth' });
    } else if (e.target.dataset.nav === 'community') {
      alert(`Community: ${userData.community.joined ? 'Joined' : 'Not joined'}`);
    } else if (e.target.dataset.nav && e.target.dataset.nav !== 'support') {
      alert(e.target.textContent.trim() + ' coming soon!');
    }
  }
});

// Countdown for mining
let countdownInt = null;
function startCountdown() {
  clearInterval(countdownInt);
  const end = userData.lastMine + MS_24H;
  const tick = () => {
    const rem = Math.max(0, Math.floor((end - Date.now()) / 1000));
    const h = Math.floor(rem / 3600),
          m = Math.floor((rem % 3600) / 60),
          s = rem % 60;
    TIMER_EL.textContent = `⏳ ${h}h ${m}m ${s}s`;
    if (rem <= 0) {
      TIMER_EL.textContent = '✅ Ready';
      MINE_BTN.disabled = false;
      MINE_BTN.textContent = '⛏ Mine';
      clearInterval(countdownInt);
    }
  };
  tick();
  countdownInt = setInterval(tick, 1000);
}

// Mining logic
MINE_BTN.onclick = async () => {
  if (Date.now() - userData.lastMine < MS_24H) return;
  const earned = RATE_PER_H * 24;
  userData.balance += earned;
  userData.lastMine = Date.now();
  const uid = auth.currentUser?.uid;
  if (uid) {
    await update(ref(rtdb, `users/${uid}`), {
      balance: userData.balance,
      lastMine: userData.lastMine,
      trustScore: userData.trustScore + 1
    });
    await updateDoc(doc(db, 'users', uid), {
      miningLevel: getLevel(userData.balance)
    });
  }
  refreshUI();
  MINE_BTN.disabled = true;
  MINE_BTN.textContent = '⏳ Wait';
  startCountdown();
  alert(`✅ Mined ${earned.toFixed(3)} EANO!`);
};

// Auth state handling
onAuthStateChanged(auth, async (user) => {
  if (user) {
    await fetchUserData(user.uid);
    if (Date.now() - userData.lastMine < MS_24H) {
      MINE_BTN.disabled = true;
      MINE_BTN.textContent = '⏳ Wait';
      startCountdown();
    }
  } else {
    window.location.href = 'index.html';
  }
});

// Navigation
MAIN_CONTENT.addEventListener('click', (e) => {
  if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
    e.preventDefault();
    if (e.target.id === 'logout-btn') {
      auth.signOut().then(() => {
        localStorage.removeItem('email');
        localStorage.removeItem('username');
        localStorage.removeItem('referral');
        localStorage.removeItem('fingerprint');
        alert('Logged out successfully.');
        window.location.href = 'index.html';
      }).catch((e) => alert('Logout failed: ' + e.message));
    } else if (e.target.dataset.nav === 'leaderboard') {
      MAIN_CONTENT.style.display = 'none';
      LEADERBOARD_SECTION.classList.add('active');
      updateLeaderboard();
    } else if (e.target.dataset.nav === 'home') {
      MAIN_CONTENT.style.display = 'block';
      LEADERBOARD_SECTION.classList.remove('active');
    } else if (e.target.dataset.nav === 'profile') {
      document.getElementById('profile-info').scrollIntoView({ behavior: 'smooth' });
    } else if (e.target.dataset.nav === 'community') {
      alert(`Community: ${userData.community.joined ? 'Joined' : 'Not joined'}`);
    } else if (e.target.dataset.nav && e.target.dataset.nav !== 'support') {
      alert(e.target.textContent.trim() + ' coming soon!');
    }
  }
});
</script>
</body>
</html>
